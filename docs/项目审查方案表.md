# 🍽️ 餐厅点餐系统 - 详尽审查方案表

**审查日期:** 2026-02-26  
**项目版本:** 1.0.0  
**审查人:** AI Agent

---

## 📋 目录

1. [项目概述](#1-项目概述)
2. [技术架构分析](#2-技术架构分析)
3. [功能模块详解](#3-功能模块详解)
4. [数据模型分析](#4-数据模型分析)
5. [业务流程梳理](#5-业务流程梳理)
6. [接口设计审查](#6-接口设计审查)
7. [前端架构分析](#7-前端架构分析)
8. [安全审查](#8-安全审查)
9. [问题与风险](#9-问题与风险)
10. [改进建议](#10-改进建议)
11. [上线 checklist](#11-上线-checklist)

---

## 1. 项目概述

### 1.1 项目定位
小型餐厅点餐管理系统，支持三端协作：
- **Admin 管理端** - 后台管理、数据统计、后厨监控
- **Pad 端** - 服务员开台、点餐、结账、清台
- **Mobile 端** - 顾客扫码点餐、查看订单

### 1.2 核心功能矩阵

| 功能模块 | Admin | Pad | Mobile | 优先级 |
|---------|-------|-----|--------|--------|
| 桌台管理 | ✅ | ✅ | ❌ | P0 |
| 菜品管理 | ✅ | ❌ | ❌ | P0 |
| 开台/点餐 | ❌ | ✅ | ✅ | P0 |
| 订单管理 | ✅ | ✅ | ✅ | P0 |
| 结账/清台 | ❌ | ✅ | ❌ | P0 |
| 后厨监控 | ✅ | ❌ | ❌ | P1 |
| 数据统计 | ✅ | ❌ | ❌ | P1 |
| 实时通知 | ✅ | ❌ | ❌ | P1 |

---

## 2. 技术架构分析

### 2.1 技术栈

| 层级 | 技术选型 | 版本 | 评估 |
|------|---------|------|------|
| **后端框架** | Spring Boot | 3.1.12 | ✅ 稳定，长期支持 |
| **Java 版本** | Java 21 (GraalVM) | 21.0.2 | ⚠️ 新特性多，但需确保团队熟悉 |
| **ORM 框架** | MyBatis Plus | 3.5.7 | ✅ 高效，减少样板代码 |
| **数据库** | MySQL | 8.0 | ✅ 主流，性能良好 |
| **缓存** | Redis | - | ✅ 支持会话、实时数据 |
| **安全** | Spring Security + JWT | - | ✅ 标准方案 |
| **实时通信** | WebSocket | - | ✅ 后厨实时通知 |
| **前端框架** | Vue 3 + TypeScript | - | ✅ 组合式 API，类型安全 |
| **UI 组件库** | Element Plus + Vant | - | ✅ 分别适配 PC/移动端 |
| **构建工具** | Vite | - | ✅ 快速，现代化 |

### 2.2 项目结构

```
restaurant-order-system/
├── restaurant-backend/          # 后端项目
│   ├── src/main/java/com/restaurant/
│   │   ├── auth/               # 认证模块
│   │   ├── dish/               # 菜品模块
│   │   ├── order/              # 订单模块 (核心业务)
│   │   ├── table/              # 桌台模块
│   │   ├── user/               # 用户模块
│   │   ├── report/             # 报表模块
│   │   ├── websocket/          # WebSocket 实时通信
│   │   └── config/             # 配置类
│   └── pom.xml
│
└── restaurant-frontend/         # 前端项目
    ├── src/views/
    │   ├── admin/              # 管理端视图
    │   ├── pad/                # Pad端视图
    │   └── mobile/             # 移动端视图
    ├── src/api/                # API 接口封装
    ├── src/stores/             # Pinia 状态管理
    └── package.json
```

### 2.3 架构评估

**优势:**
- 前后端分离，职责清晰
- 模块化设计，便于维护扩展
- WebSocket 实现实时后厨通知
- JWT 无状态认证，易于水平扩展

**潜在风险:**
- 所有移动端 API 完全开放，无认证 ⚠️
- 缺少 API 限流和防刷机制 ⚠️
- 缺少分布式事务处理 ⚠️

---

## 3. 功能模块详解

### 3.1 认证模块 (Auth)

| 功能点 | 实现状态 | 备注 |
|--------|---------|------|
| JWT 登录 | ✅ | Token 有效期 24 小时 |
| 密码加密 | ✅ | BCrypt 加密 |
| 角色权限 | ⚠️ | 仅区分 admin/waiter，未细粒度控制 |
| Token 刷新 | ❌ | 缺失，长期操作可能过期 |

**代码位置:**
- `auth/controller/AuthController.java`
- `config/JwtAuthenticationFilter.java`
- `utils/JwtUtil.java`

### 3.2 桌台模块 (Table)

**状态流转:**
```
空闲(0) → 开台 → 使用中(1) → 结账 → 待清台(2) → 清台 → 空闲(0)
```

| 功能点 | 实现状态 | 备注 |
|--------|---------|------|
| 桌台 CRUD | ✅ | 支持固定/临时桌 |
| 开台 | ✅ | 记录用餐人数 |
| 状态管理 | ✅ | 0空闲/1使用中/2待清台 |
| 二维码生成 | ⚠️ | 仅生成 URL，未生成图片 |
| 桌台统计 | ✅ | 消费金额排行 |

**核心方法:**
- `TableService.openTable()` - 开台
- `TableService.clearTable()` - 清台
- `TableService.setPendingClear()` - 设为待清台

### 3.3 菜品模块 (Dish)

| 功能点 | 实现状态 | 备注 |
|--------|---------|------|
| 分类管理 | ✅ | CRUD 完整 |
| 菜品管理 | ✅ | 支持上架/下架 |
| 库存管理 | ⚠️ | 基础实现，无库存预警 |
| 推荐菜品 | ✅ | is_recommend 字段 |
| 图片上传 | ✅ | 本地存储 |

**数据快照机制:**
- 订单创建时，菜品名称、价格、图片会快照保存到 `order_item`
- 防止菜品修改后影响历史订单

### 3.4 订单模块 (Order) - 核心业务

**订单状态:**
| 状态码 | 含义 | 触发条件 |
|--------|------|---------|
| 0 | 待上菜 | 新订单默认状态 |
| 1 | 上菜中 | 有菜品开始制作 |
| 2 | 待结账 | 所有菜品制作完成 |
| 3 | 已完成 | 全部结账完成 |
| 4 | 追加订单 | 已结账后又加菜 |
| 5 | 已取消 | 订单取消 |

**菜品状态 (order_item):**
| 状态码 | 含义 | 流转 |
|--------|------|------|
| 0 | 待制作 | → 1 |
| 1 | 制作中 | → 2 |
| 2 | 已完成 | 终态 |

**核心功能:**

| 功能点 | 实现状态 | 备注 |
|--------|---------|------|
| 创建订单 | ✅ | 支持购物车批量 |
| 加菜 | ✅ | 支持追加到现有订单 |
| 菜品状态更新 | ✅ | 自动触发订单状态流转 |
| 部分结账 | ✅ | 支持分批结账 |
| 订单取消 | ✅ | 恢复库存 |
| 订单查询 | ✅ | 多维度查询 |

**服务分层:**
- `OrderService` - 基础 CRUD、创建订单、加菜
- `OrderStatusService` - 状态流转、结账、完成订单

**关键问题修复:**
- ✅ **已修复:** 结账后桌台自动变为"待清台"状态

### 3.5 后厨模块 (Kitchen)

| 功能点 | 实现状态 | 备注 |
|--------|---------|------|
| 实时订单推送 | ✅ | WebSocket |
| 菜品状态更新 | ✅ | 待制作→制作中→已完成 |
| 新订单提醒 | ✅ | 声音+视觉提醒 |
| 排序功能 | ✅ | 按时间/桌号/状态 |
| 自动刷新 | ✅ | 30秒轮询+WebSocket |

**WebSocket 事件类型:**
- `NEW_ORDER` - 新订单
- `ORDER_STATUS` - 订单状态变更
- `ITEM_STATUS` - 菜品状态变更

### 3.6 报表模块 (Report)

| 功能点 | 实现状态 | 备注 |
|--------|---------|------|
| 今日营业额 | ✅ | 实时统计 |
| 今日订单数 | ✅ | 实时统计 |
| 平均客单价 | ✅ | 计算得出 |
| 热销菜品 TOP5 | ✅ | 按销量排序 |
| 桌台消费排行 | ✅ | 按金额排序 |
| 营业额趋势图 | ⚠️ | 使用模拟数据 |

---

## 4. 数据模型分析

### 4.1 ER 图核心关系

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  sys_user   │     │restaurant_  │     │dish_category│
│  (用户)      │     │table (桌台) │     │  (分类)      │
└─────────────┘     └──────┬──────┘     └──────┬──────┘
                           │                    │
                           │ 1:N                │ 1:N
                           ▼                    ▼
                    ┌─────────────┐     ┌─────────────┐
                    │   orders    │     │    dish     │
                    │  (订单)      │     │   (菜品)     │
                    └──────┬──────┘     └─────────────┘
                           │
                           │ 1:N
                           ▼
                    ┌─────────────┐
                    │  order_item │
                    │  (订单明细)  │
                    └─────────────┘
```

### 4.2 核心表结构

**订单表 (orders)**
```sql
CREATE TABLE orders (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  order_no VARCHAR(32) UNIQUE,      -- 订单编号 ORD20260226XXXXXX
  table_id BIGINT,                   -- 桌台ID
  table_no VARCHAR(20),              -- 桌号(冗余)
  customer_count INT DEFAULT 1,      -- 用餐人数
  total_amount DECIMAL(10,2),        -- 订单总金额
  discount_amount DECIMAL(10,2),     -- 优惠金额
  pay_amount DECIMAL(10,2),          -- 实付金额
  pay_type TINYINT,                  -- 0未支付 1微信 2支付宝 3现金
  pay_time DATETIME,                 -- 支付时间
  status TINYINT DEFAULT 0,          -- 订单状态
  remark VARCHAR(500),               -- 订单备注
  created_at DATETIME,               -- 创建时间
  updated_at DATETIME                -- 更新时间
);
```

**订单明细表 (order_item)**
```sql
CREATE TABLE order_item (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  order_id BIGINT NOT NULL,          -- 订单ID
  dish_id BIGINT NOT NULL,           -- 菜品ID
  dish_name VARCHAR(100),            -- 菜品名称(快照)
  dish_image VARCHAR(255),           -- 菜品图片(快照)
  price DECIMAL(10,2),               -- 单价(快照)
  quantity INT NOT NULL,             -- 数量
  subtotal DECIMAL(10,2),            -- 小计金额
  remark VARCHAR(200),               -- 备注
  status TINYINT DEFAULT 0,          -- 0待制作 1制作中 2已完成
  is_paid TINYINT DEFAULT 0,         -- 是否已结账(支持部分结账)
  created_at DATETIME,
  updated_at DATETIME
);
```

### 4.3 索引设计评估

| 表名 | 索引 | 评估 |
|------|------|------|
| orders | idx_table_id | ✅ 按桌台查询订单 |
| orders | idx_status | ✅ 按状态筛选 |
| orders | idx_created_at | ✅ 时间范围查询 |
| order_item | idx_order_id | ✅ 查询订单明细 |
| order_item | **idx_is_paid** | ❌ **缺失** - 结账时频繁查询 |

**建议添加索引:**
```sql
-- 优化结账时的未结账菜品查询
CREATE INDEX idx_order_item_unpaid ON order_item(order_id, is_paid);
```

---

## 5. 业务流程梳理

### 5.1 标准点餐流程

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│  顾客到店  │ → │  服务员开台 │ → │  扫码/Pad点餐 │ → │  后厨制作   │ → │  上菜     │
└─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘
                                                                     ↓
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│  桌台空闲  │ ← │   清台    │ ← │  结账收款   │ ← │  顾客用餐   │ ← │  叫号取餐  │
└─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘
```

### 5.2 状态机详解

**桌台状态机:**
```
                    ┌─────────────┐
         ┌─────────▶│   空闲(0)   │◀────────┐
         │          └──────┬──────┘         │
         │                 │ 开台            │ 清台
         │                 ▼                │
    取消订单│          ┌─────────────┐       │
    (无其他订│    ┌────│  使用中(1)  │────┐  │
    单)     └────┘    └──────┬──────┘    │  │
                              │ 结账       │  │
                              ▼            │  │
                         ┌─────────────┐   │  │
                         │  待清台(2)   │───┘  │
                         └─────────────┘      │
                              │ 加菜           │
                              └───────────────┘
```

**订单状态机:**
```
待上菜(0) ──有菜品开始制作──▶ 上菜中(1) ──所有菜品完成──▶ 待结账(2)
    │                                                    │
    │                                                    │ 结账
    │                                                    ▼
 取消│                                              已完成(3) ◀──┐
    │                                                    │        │
    ▼                                               加菜后结账    │
 已取消(5)                                            追加订单(4)──┘
```

### 5.3 异常流程

| 异常场景 | 处理方式 | 实现状态 |
|---------|---------|---------|
| 顾客取消订单 | 订单状态→5，恢复库存 | ✅ |
| 菜品售罄 | 下单时校验库存 | ✅ |
| 结账时加菜 | 创建新订单项，状态→4 | ✅ |
| 部分结账 | 按菜品标记 is_paid | ✅ |
| 网络中断 | WebSocket 自动重连 | ✅ |

---

## 6. 接口设计审查

### 6.1 RESTful 规范

| 规范项 | 符合度 | 说明 |
|--------|-------|------|
| URL 命名 | ✅ | 使用名词复数 `/api/orders` |
| HTTP 方法 | ⚠️ | 部分使用 POST 代替 PUT |
| 状态码 | ⚠️ | 业务错误也返回 200，依赖 code 字段 |
| 版本控制 | ❌ | 未做 API 版本管理 |

### 6.2 核心接口清单

| 接口 | 方法 | 认证 | 说明 |
|------|------|------|------|
| `/api/auth/login` | POST | 公开 | 登录获取 Token |
| `/api/auth/register` | POST | 公开 | 注册 (开发环境) |
| `/api/tables` | GET | ✅ | 桌台列表 |
| `/api/tables/{id}/open` | POST | ✅ | 开台 |
| `/api/tables/{id}/clear` | POST | ✅ | 清台 |
| `/api/orders` | POST | 公开 | 创建订单 ⚠️ |
| `/api/orders/{id}/pay` | POST | ✅ | 结账 |
| `/api/orders/items/{id}/status` | POST | ✅ | 更新菜品状态 |
| `/api/dishes` | GET | 公开 | 菜品列表 ⚠️ |
| `/ws/kitchen` | WS | Token | WebSocket 连接 |

### 6.3 接口安全问题 ⚠️

**高风险:**
```java
// SecurityConfig.java 中移动端 API 完全开放
.requestMatchers("/api/dishes/**").permitAll()
.requestMatchers("/api/tables/**").permitAll()
.requestMatchers("/api/orders/**").permitAll()
```

**风险:**
- 任何人可调用 `/api/orders` 创建恶意订单
- 任何人可获取所有桌台、菜品信息
- 缺少请求频率限制，易被刷

**建议:**
- 移动端使用临时 Token 或签名验证
- 添加请求限流 (Rate Limiting)
- 敏感操作添加验证码

---

## 7. 前端架构分析

### 7.1 三端设计

| 端 | 技术栈 | 路由前缀 | 主要功能 |
|---|--------|---------|---------|
| Admin | Vue3 + Element Plus | `/admin/*` | 后台管理、后厨、报表 |
| Pad | Vue3 + Element Plus | `/pad/*` | 开台、点餐、结账 |
| Mobile | Vue3 + Vant | `/m/*` | 扫码点餐 |

### 7.2 状态管理

**Pinia Store 设计:**
```typescript
// stores/cart.ts
interface CartState {
  items: CartItem[]        // 购物车商品
  tableId: number          // 当前桌台
  tableNo: string          // 桌号
  customerCount: number    // 用餐人数
}
```

**评价:**
- ✅ 状态集中管理
- ⚠️ 购物车未持久化，刷新丢失
- ⚠️ 缺少全局错误处理 Store

### 7.3 组件复用

| 组件 | 复用度 | 评估 |
|------|-------|------|
| 订单卡片 | 中 | Admin/Pad 有类似卡片 |
| 菜品列表 | 低 | Pad/Mobile 各自实现 |
| 结账弹窗 | 低 | Pad/Orders 各自实现 |

**建议:**
- 提取公共业务组件到 `components/business/`
- 统一结账、订单详情等通用组件

### 7.4 API 封装

```typescript
// api/order.ts
export function createOrder(data: any): Promise<any>
export function payOrder(orderId: number, data: any): Promise<any>
export function updateItemStatus(itemId: number, status: number): Promise<any>
```

**评价:**
- ✅ 统一封装 request
- ⚠️ 类型定义使用 `any`，缺少严格类型
- ⚠️ 错误处理分散在各组件

---

## 8. 安全审查

### 8.1 认证授权

| 检查项 | 状态 | 说明 |
|--------|------|------|
| 密码加密 | ✅ | BCrypt |
| JWT 签名 | ✅ | HMAC SHA256 |
| Token 过期 | ✅ | 24 小时 |
| Token 刷新 | ❌ | 未实现 |
| 权限控制 | ⚠️ | 仅区分角色，无资源权限 |

### 8.2 数据安全

| 检查项 | 状态 | 说明 |
|--------|------|------|
| SQL 注入 | ✅ | MyBatis Plus 参数化 |
| XSS 防护 | ⚠️ | 依赖前端，后端未做转义 |
| 敏感数据脱敏 | ❌ | 手机号、姓名未脱敏 |
| 接口防重放 | ❌ | 无时间戳/随机数校验 |

### 8.3 部署安全

| 检查项 | 状态 | 说明 |
|--------|------|------|
| HTTPS | ❌ | 开发环境使用 HTTP |
| CORS 配置 | ⚠️ | WebSocket 允许所有来源 |
| 文件上传限制 | ⚠️ | 未限制文件类型和大小 |

---

## 9. 问题与风险

### 9.1 已修复问题 ✅

| 问题 | 修复方案 | 验证状态 |
|------|---------|---------|
| 清台流程异常 | 结账后自动更新桌台为待清台 | ✅ 已验证 |
| Lombok 编译失败 | 更新 Lombok 版本到 1.18.34 | ✅ 已验证 |

### 9.2 待修复问题 🔴

| 优先级 | 问题 | 影响 | 建议方案 |
|--------|------|------|---------|
| **P0** | 移动端 API 无认证 | 任何人可创建订单 | 添加临时 Token 机制 |
| **P0** | 缺少接口限流 | 易被恶意刷单 | 添加 Rate Limiting |
| **P1** | 订单金额计算待验证 | 可能金额不符 | 添加单元测试验证 |
| **P1** | 购物车未持久化 | 刷新丢失 | LocalStorage 持久化 |
| **P1** | Token 无刷新机制 | 长期操作会过期 | 实现 Refresh Token |
| **P2** | 报表使用模拟数据 | 数据不准确 | 实现真实数据统计 |
| **P2** | 缺少操作日志 | 无法追踪问题 | 添加审计日志 |

### 9.3 技术债务 📋

| 类别 | 描述 | 影响 |
|------|------|------|
| 类型安全 | 多处使用 `any` 类型 | 运行时错误风险 |
| 代码重复 | Pad/Orders 结账逻辑重复 | 维护困难 |
| 硬编码 | WebSocket URL 硬编码 | 环境切换不便 |
| 异常处理 | 全局异常处理不完善 | 错误信息泄露 |

---

## 10. 改进建议

### 10.1 短期优化 (1-2 周)

1. **安全加固**
   ```java
   // 添加接口限流
   @RateLimiter(name = "createOrder", capacity = 10, refillTokens = 5)
   @PostMapping
   public Result<Order> create(@RequestBody CreateOrderRequest request) { ... }
   ```

2. **移动端认证**
   - 扫码时生成临时 Token (有效期 2 小时)
   - 或验证桌台二维码中的签名

3. **购物车持久化**
   ```typescript
   // stores/cart.ts
   const CART_STORAGE_KEY = 'restaurant_cart'
   
   // 初始化时从 LocalStorage 读取
   const savedCart = localStorage.getItem(CART_STORAGE_KEY)
   if (savedCart) {
     items.value = JSON.parse(savedCart)
   }
   
   // 监听变化自动保存
   watch(items, (newItems) => {
     localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(newItems))
   }, { deep: true })
   ```

### 10.2 中期改进 (1 个月)

1. **打印小票功能**
   - 集成 ESC/POS 打印协议
   - 支持 USB/网络打印机
   - 打印订单小票和结账单

2. **数据报表完善**
   - 实现真实的小时级营业额统计
   - 添加订单来源分析 (Pad/扫码)
   - 添加菜品销售趋势

3. **消息通知优化**
   - 集成短信/微信模板消息
   - 订单状态变更通知顾客
   - 后厨超时提醒

### 10.3 长期规划 (3 个月)

1. **多门店支持**
   - 添加门店表
   - 数据隔离
   - 总部统一管理

2. **会员系统**
   - 积分累积
   - 会员等级
   - 优惠券管理

3. **预订系统**
   - 在线预订桌台
   - 预订提醒
   - 排队叫号

---

## 11. 上线 Checklist

### 11.1 功能测试 ✅

- [x] 登录/登出
- [x] 开台/点餐/结账/清台完整流程
- [x] 加菜功能
- [x] 部分结账
- [x] 订单取消
- [x] 后厨实时通知
- [x] 多订单并发处理
- [ ] 移动端扫码点餐 (待验证)
- [ ] 支付金额准确性验证

### 11.2 性能测试 📊

- [ ] 并发订单创建 (JMeter)
- [ ] 数据库连接池优化
- [ ] Redis 缓存策略
- [ ] 前端首屏加载优化

### 11.3 安全加固 🔒

- [ ] 移动端 API 认证
- [ ] 接口限流
- [ ] HTTPS 证书配置
- [ ] 敏感数据脱敏
- [ ] 操作日志记录

### 11.4 部署准备 🚀

- [ ] Docker 镜像构建
- [ ] 生产环境配置分离
- [ ] 数据库迁移脚本
- [ ] 监控告警配置
- [ ] 备份策略

---

## 附录

### A. 测试账号

| 角色 | 用户名 | 密码 |
|------|--------|------|
| 管理员 | admin | admin123 |
| 服务员 | waiter | 123456 |

### B. 运行端口

| 服务 | 端口 | 说明 |
|------|------|------|
| 后端 API | 8080 | RESTful API |
| WebSocket | 8080 | 同一端口 |
| 前端开发 | 5173 | Vite Dev Server |
| MySQL | 3307 | 开发环境 |

### C. 快速启动

```bash
# 后端
cd restaurant-backend
mvn spring-boot:run -Dspring-boot.run.profiles=dev

# 前端
cd restaurant-frontend
npm run dev
```

---

**文档版本:** 1.0  
**最后更新:** 2026-02-26  
**作者:** AI Agent
